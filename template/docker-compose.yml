# =============================================================================
# ASSETTRACK MONOREPO - DOCKER COMPOSE CONFIGURATION
# =============================================================================
# This docker-compose.yml references environment variables from the root .env file
# It can also work with Coolify where variables are injected via Coolify's UI
#
# IMPORTANT: Infrastructure services (Neo4j, Redis, MinIO) are expected to run
# externally and are configured via the .env file connection strings.
#
# Usage:
#   docker compose up                     # Start all three services (api, worker, web)
#   docker compose up api                 # Start only API service
#   docker compose up worker              # Start only Worker service
#   docker compose up web                 # Start only Web service
#   docker compose up api worker          # Start API and Worker services
# =============================================================================
x-api-worker-shared-env: &api_worker_shared_env
  # Database - Use .env values (external services)
  NEO4J_URI: ${NEO4J_URI}
  NEO4J_USER: ${NEO4J_USER}
  NEO4J_PASSWORD: ${NEO4J_PASSWORD}
  NEO4J_DATABASE: ${NEO4J_DATABASE}

  # Cache & Queue - Use .env values (external services)
  REDIS_HOST: ${REDIS_HOST}
  REDIS_PORT: ${REDIS_PORT}
  REDIS_PASSWORD: ${REDIS_PASSWORD}
  REDIS_USERNAME: ${REDIS_USERNAME}
  REDIS_QUEUE: ${REDIS_QUEUE}

  # Authentication
  JWT_SECRET: ${JWT_SECRET}
  JWT_EXPIRES_IN: ${JWT_EXPIRES_IN}

  # Web Push - VAPID
  VAPID_PUBLIC_KEY: ${VAPID_PUBLIC_KEY}
  VAPID_PRIVATE_KEY: ${VAPID_PRIVATE_KEY}
  VAPID_EMAIL: ${VAPID_EMAIL}

  # Email Configuration
  EMAIL_PROVIDER: ${EMAIL_PROVIDER}
  EMAIL_API_KEY: ${EMAIL_API_KEY}
  EMAIL_FROM: ${EMAIL_FROM}
  EMAIL_HOST: ${EMAIL_HOST}
  EMAIL_PORT: ${EMAIL_PORT}
  EMAIL_SECURE: ${EMAIL_SECURE}
  EMAIL_USERNAME: ${EMAIL_USERNAME}
  EMAIL_PASSWORD: ${EMAIL_PASSWORD}

  # Logging - Loki
  LOKI_ENABLED: ${LOKI_ENABLED}
  LOKI_HOST: ${LOKI_HOST}
  LOKI_USERNAME: ${LOKI_USERNAME}
  LOKI_PASSWORD: ${LOKI_PASSWORD}
  LOKI_APP_LABEL: ${LOKI_APP_LABEL}

  # Tracing - Tempo
  TEMPO_ENABLED: ${TEMPO_ENABLED}
  TEMPO_ENDPOINT: ${TEMPO_ENDPOINT}
  TEMPO_SERVICE_NAME: ${TEMPO_SERVICE_NAME}
  TEMPO_SERVICE_VERSION: ${TEMPO_SERVICE_VERSION}

  # Object Storage - S3/MinIO - Use .env values (external services)
  S3_TYPE: ${S3_TYPE}
  S3_ENDPOINT: ${S3_ENDPOINT}
  S3_BUCKET: ${S3_BUCKET}
  S3_ACCESS_KEY_ID: ${S3_ACCESS_KEY_ID}
  S3_SECRET_ACCESS_KEY: ${S3_SECRET_ACCESS_KEY}
  S3_REGION: ${S3_REGION}

  # ai
  AI_PROVIDER: ${AI_PROVIDER}
  AI_API_KEY: ${AI_API_KEY}
  AI_MODEL: ${AI_MODEL}
  AI_URL: ${AI_URL}
  AI_REGION: ${AI_REGION}
  AI_SECRET: ${AI_SECRET}
  AI_INSTANCE: ${AI_INSTANCE}
  AI_API_VERSION: ${AI_API_VERSION}
  AI_INPUT_COST_PER_1M_TOKENS: ${AI_INPUT_COST_PER_1M_TOKENS}
  AI_OUTPUT_COST_PER_1M_TOKENS: ${AI_OUTPUT_COST_PER_1M_TOKENS}
  
  #transcriber
  TRANSCRIBER_PROVIDER: ${TRANSCRIBER_PROVIDER}
  TRANSCRIBER_API_KEY: ${TRANSCRIBER_API_KEY}
  TRANSCRIBER_MODEL: ${TRANSCRIBER_MODEL}
  TRANSCRIBER_URL: ${TRANSCRIBER_URL}
  TRANSCRIBER_API_VERSION: ${TRANSCRIBER_API_VERSION}

  # embedder
  EMBEDDER_PROVIDER: ${EMBEDDER_PROVIDER}
  EMBEDDER_API_KEY: ${EMBEDDER_API_KEY}
  EMBEDDER_MODEL: ${EMBEDDER_MODEL}
  EMBEDDER_INSTANCE: ${EMBEDDER_INSTANCE}
  EMBEDDER_API_VERSION: ${EMBEDDER_API_VERSION}
  EMBEDDER_DIMENSIONS: ${EMBEDDER_DIMENSIONS}

# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # API Server (NestJS Backend)
  # ---------------------------------------------------------------------------
  api:
    build:
      context: .
      dockerfile: Dockerfile
      target: api-production
      args:
        - API_PORT=${API_PORT:-3400}
    ports:
      - "${API_PORT:-3400}:${API_PORT:-3400}"
    environment:
      <<: *api_worker_shared_env
      # Build & Application Mode
      PORT: ${API_PORT:-3400}
      API_URL: ${API_URL}
      API_PORT: ${API_PORT:-3400}
      NODE_OPTIONS: ${API_NODE_OPTIONS:-"--max-old-space-size=6144"}

      # Cache Configuration
      CACHE_ENABLED: ${CACHE_ENABLED}
      CACHE_DEFAULT_TTL: ${CACHE_DEFAULT_TTL}
      CACHE_SKIP_PATTERNS: ${CACHE_SKIP_PATTERNS}

      # Rate Limiting
      RATE_LIMIT_ENABLED: ${RATE_LIMIT_ENABLED}
      RATE_LIMIT_TTL: ${RATE_LIMIT_TTL}
      RATE_LIMIT_REQUESTS: ${RATE_LIMIT_REQUESTS}
      IP_RATE_LIMIT_REQUESTS: ${IP_RATE_LIMIT_REQUESTS}

      # CORS Configuration
      CORS_ORIGINS: ${CORS_ORIGINS}
      CORS_ORIGIN_PATTERNS: ${CORS_ORIGIN_PATTERNS}
      CORS_CREDENTIALS: ${CORS_CREDENTIALS}
      CORS_METHODS: ${CORS_METHODS}
      CORS_ALLOWED_HEADERS: ${CORS_ALLOWED_HEADERS}
      CORS_MAX_AGE: ${CORS_MAX_AGE}
      CORS_PREFLIGHT_CONTINUE: ${CORS_PREFLIGHT_CONTINUE}
      CORS_OPTIONS_SUCCESS_STATUS: ${CORS_OPTIONS_SUCCESS_STATUS}
      CORS_LOG_VIOLATIONS: ${CORS_LOG_VIOLATIONS}
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get({host:'localhost',port:process.env.API_PORT||3400,path:'/version'},(r)=>process.exit(r.statusCode>=200&&r.statusCode<500?0:1))"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 40s

  # ---------------------------------------------------------------------------
  # Worker (Background Job Processing)
  # ---------------------------------------------------------------------------
  worker:
    build:
      context: .
      dockerfile: Dockerfile
      target: api-production
    environment:
      <<: *api_worker_shared_env
      NODE_OPTIONS: ${WORKER_NODE_OPTIONS:-"--max-old-space-size=6144"}
    healthcheck:
      test: ["CMD", "pgrep", "-f", "node.*dist/main.*worker"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    command:
      - node
      - dist/main
      - --mode=worker

  # ---------------------------------------------------------------------------
  # Web Application (Next.js Frontend)
  # ---------------------------------------------------------------------------
  web:
    build:
      context: .
      dockerfile: Dockerfile
      target: web-production
      args:
        - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
        - NEXT_PUBLIC_ADDRESS=${NEXT_PUBLIC_ADDRESS}
        - NEXT_PUBLIC_VAPID_PUBLIC_KEY=${NEXT_PUBLIC_VAPID_PUBLIC_KEY}
        - NEXT_PUBLIC_GOOGLE_MAPS_API_KEY=${NEXT_PUBLIC_GOOGLE_MAPS_API_KEY}
        - PORT=${PORT:-3401}
    ports:
      - "${PORT:-3401}:${PORT:-3401}"
    environment:
      # Build & Application Configuration
      - PORT=${PORT:-3401}
      - APP_URL=${APP_URL}
      - NODE_OPTIONS=${WEB_NODE_OPTIONS:-"--max-old-space-size=4096"}

      # API Connection
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
      - NEXT_PUBLIC_ADDRESS=${NEXT_PUBLIC_ADDRESS}
      - API_INTERNAL_URL=${API_INTERNAL_URL:-http://api:3400/}

      # Web Push - VAPID
      - NEXT_PUBLIC_VAPID_PUBLIC_KEY=${NEXT_PUBLIC_VAPID_PUBLIC_KEY}

      # Image Sources
      - IMAGE_SOURCES=${IMAGE_SOURCES}

      # Google Maps API Key
      - NEXT_PUBLIC_GOOGLE_MAPS_API_KEY=${NEXT_PUBLIC_GOOGLE_MAPS_API_KEY}
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get({host:'localhost',port:process.env.PORT||3401,path:'/'},(r)=>process.exit(r.statusCode>=200&&r.statusCode<500?0:1))"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 40s
